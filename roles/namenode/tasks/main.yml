--- 
- import_tasks: base.yml
- import_tasks: hadoop.yml

- name: setup data folders
  block:
  - name: create /data/nn folder
    ansible.builtin.file:
      path: /data/nn
      state: directory
      owner: hdfs
      group: hdfs
      mode: '0755'

  - name: generate workers files
    ansible.builtin.template:
      src: workers.j2
      dest: /etc/hadoop/workers
      owner: hdfs
      group: hdfs
      mode: '0644'

- name: format or bootstrap namenode
  block:
  - name: start journal nodes 
    command: /opt/hadoop/bin/hdfs --workers --daemon start journalnode
    become_user: hdfs
     
  - name: format primary namenode
    command: /opt/hadoop/bin/hdfs namenode -format 
    become_user: hdfs
    args:
      creates: /data/nn/current/VERSION
    when: inventory_hostname == groups['namenodes'][0]

  - name: bootstrap secondary namenode
    command: /opt/hadoop/bin/hdfs namenode -bootstrapStandby
    become_user: hdfs
    args:
      creates: /data/nn/current/VERSION
    when: inventory_hostname != groups['namenodes'][0]

  - name: stop journal nodes
    command: /opt/hadoop/bin/hdfs --workers --daemon stop journalnode
    become_user: hdfs

- name: initializing ha state if required
  command: /opt/hadoop/bin/hdfs zkfc -formatZK -nonInteractive
  become_user: hdfs
  # if the ha state is already initialized, the return code will be 2
  register: zk_init_result
  failed_when: zk_init_result.rc == 1 

